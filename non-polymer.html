<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Caching with Service Workers</title>

    <link rel="stylesheet" href="../../styles/main.css">

    <style>
      .cached:after {
        content: ' (cached)';
      }
    </style>

    <script>
      navigator.serviceWorker.register('service-worker.js', { scope: './' }).then(function(serviceWorker) {
        function sendMessage(payload) {
          return new Promise(function(resolve) {
            var messageChannel = new MessageChannel();
            messageChannel.port1.onmessage = function(e) {
              console.log('onmessage; data is', e.data);
              resolve(e);
            };

            payload.port = messageChannel.port2;
            serviceWorker.postMessage(payload, [messageChannel.port2]);
          });
        }

        function command(command, file) {
          sendMessage({
            command: command,
            file: file
          }).then(function(e) {
            document.getElementById(e.data.file).classList.toggle('cached', e.data.cached);
          });
        }

        function cache(file) {
          command('cache', file);
        }

        function uncache(file) {
          command('uncache', file);
        }

        function getStatus(file) {
          command('status', file);
        }

        // In a more useful scenario, this would be a dynamically generated list of file paths.
        var files = ['file1.txt', 'file2.txt', 'file3.txt', 'file4.txt'];
        var filesListElement = document.getElementById('files-list');
        files.forEach(function(file) {
          var fileElement = document.createElement('li');
          fileElement.id = file;
          fileElement.innerHTML = '<button>Toggle</button> <a href="' + file + '">' + file + '</a>';
          filesListElement.appendChild(fileElement);

          getStatus(file);
        });

        window.addEventListener('click', function(e) {
          if (e.srcElement.nodeName == 'BUTTON') {
            e.preventDefault();

            var fileElement = e.srcElement.parentElement;
            if (fileElement.classList.contains('cached')) {
              uncache(fileElement.id);
            } else {
              cache(fileElement.id);
            }
          }
        });
      });
    </script>
  </head>

  <body>
    <h1>Caching with Service Workers</h1>

    <p>See <a href="https://jakearchibald.github.io/isserviceworkerready/">Is Service Worker Ready?</a> for info about browser support.</p>
    <p>Since Chrome Canary doesn't natively support all of the caching mechanisms we need, this code makes use of polyfills.</p>

    <ul id="files-list"></ul>
  </body>
</html>