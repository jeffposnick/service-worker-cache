<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <title>service-worker-cache Demo</title>

    <script src="../platform/platform.js"></script>
    <link rel="import" href="../core-icon-button/core-icon-button.html">
    <link rel="import" href="service-worker-cache.html">
    <link rel="import" href="service-worker-cacheable-resource.html">

    <style>
      body {
        font-family: "Open Sans", Helvetica, sans-serif;
      }

      section {
        margin-top: 2em;
      }

      header {
        font-size: 1.5em;
        font-weight: bold;
      }

      ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>

  <body unresolved>
    <h1><code>&lt;service-worker-cache&gt;</code> Demo</h1>

    <template id="page-template" is="auto-binding">
      <service-worker-cache initialized="{{initialized}}"></service-worker-cache>

      <template if="{{ initialized }}">
        <ul>
          <template repeat="{{ relativeUrl, i in relativeUrls }}">
            <li>
              {{i}}
              <service-worker-cacheable-resource relativeUrl="{{relativeUrl}}"
                                                 cached="{{cached[relativeUrl]}}"
                                                 auto?="{{ i == 1 }}">
              </service-worker-cacheable-resource>

              <template if="{{ cached[relativeUrl] }}">
                <core-icon-button icon="cloud-done"
                                  title="Cached; press to remove."
                                  data-command="uncache"
                                  data-relative-url="{{relativeUrl}}">
                </core-icon-button>
              </template>

              <template if="{{ !cached[relativeUrl] }}">
                <core-icon-button icon="cloud-off"
                                  title="Not cached; press to download."
                                  data-command="cache"
                                  data-relative-url="{{relativeUrl}}">
                </core-icon-button>
              </template>

              <a href="{{relativeUrl}}">{{relativeUrl}}</a>
            </li>
          </template>
        </ul>
      </template>
    </template>

    <script>
      var pageTemplate = document.querySelector('#page-template');
      pageTemplate.cached = {};
      pageTemplate.relativeUrls = [
        'dummy-files/file1.txt',
        'dummy-files/file2.txt',
        'dummy-files/file3.txt',
        'dummy-files/file4.txt',
        'dummy-files/file5.txt',
        'dummy-files/file6.txt',
        'dummy-files/file7.txt',
        'dummy-files/file8.txt',
        'dummy-files/file9.txt',
        'dummy-files/file10.txt'
      ];

      pageTemplate.addEventListener('template-bound', function() {
        var serviceWorkerCache = document.querySelector('service-worker-cache');
        serviceWorkerCache.addEventListener('service-worker-cache-initialized', function() {
          serviceWorkerCache.relativeUrls = [pageTemplate.relativeUrls[0]];
        });
      });

      // There's got to be a better way to handle clicks on elements in a conditional template, but...
      document.body.addEventListener('click', function(e) {
        if (e.srcElement.dataset.relativeUrl && e.srcElement.dataset.command) {
          e.preventDefault();

          if (e.srcElement.dataset.command == 'cache') {
            document.querySelector('service-worker-cache').cache(e.srcElement.dataset.relativeUrl);
          } else if (e.srcElement.dataset.command == 'uncache') {
            document.querySelector('service-worker-cache').uncache(e.srcElement.dataset.relativeUrl);
          }
        }
      });
    </script>

    <section>
      <header>Caveats</header>
      <p>
        At the moment, this demo, and service workers in general, only work in Google Chrome Canary with
        <a href="chrome://flags/#enable-experimental-web-platform-features">experimental web features</a> enabled.
        (Tested against version <code>38.0.2117.2</code>.)
      </p>
      <p>
        The standards around service worker caching are still very much in flux, and this demo relies on a
        <a href="https://github.com/jeffposnick/service-worker-cache/commit/5b563295f211a8a64f0732e8879b712ea46b0a75">modified</a>
        version of the polyfills that shipped as part of <a href="https://github.com/Polymer/topeka/tree/master/polyfills">Topeka</a>.
        As new versions of the Canary are built, and more functionality becomes native, I'd expect that more changes will be needed
        to the polyfills (or some might not be necessary anymore.
      </p>
    </section>

    <section>
      <header>Learning More</header>
      <p>To learn more about service workers, Alex Russell's <a href="https://github.com/slightlyoff/ServiceWorker/blob/master/explainer.md">explainer document</a> is the place to start.</p>
      <p>You can debug what the service worker handling a page is doing via <a href="chrome://serviceworker-internals/">serviceworker-internals</a>.</p>
      <p>The current polyfill implementation caches resources using IndexedDB, so you can manually inspect that to see what's being cached.</p>
    </section>

    <section>
      <header>About This Demo</header>
      <p>Now that that's out of the way... the demo! There are a few links to files which can be cached/uncached via the corresponding buttons.</p>
      <p>The first URL is cached automatically via the <code>relativeUrls</code> property of the <code>&lt;service-worker-cacheable-resource&gt;</code>. If you know that there are certain files that your page will always want cached, this is the most straightforward way to do it.</p>
      <p>It's possible to use this element to pre-cache resources, by setting the <code>auto</code> on the <code>&lt;service-worker-cacheable-resource&gt;</code>. That's what's done with the second URL.</p>
      <p>Visiting any of the links will also add it to the cache (reflected next time you reload the page).</p>
      <p>When experimenting, start with a fresh Incognito window in Chrome Canary.</p>
      <p>Try caching a few resources, then turning off your network connection. You'll be able to load them!</p>
    </section>
  </body>
</html>
